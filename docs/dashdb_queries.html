---

title: Title


keywords: fastai
sidebar: home_sidebar



nb_path: "05a_dashdb_queries.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 05a_dashdb_queries.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">DASHBOARD_CORPUS</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT d.* </span>
<span class="s2">FROM PREFIX_CORPUS as d</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">DASHBOARD_CORPUS_TO_PAPER</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT dp.* </span>
<span class="s2">FROM PREFIX_CORPUS as d</span>
<span class="s2">        INNER JOIN PREFIX_CORPUS_TO_PAPER as dp on (d.ID=dp.ID_CORPUS)</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">DASHBOARD_PAPER</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT DISTINCT * FROM (</span>
<span class="s2">    SELECT DISTINCT p.id AS ID, p.DOI, p.TITLE, p.ABSTRACT, p.YEAR, p.MONTH, </span>
<span class="s2">        p.DAY, p.VOLUME, p.ISSUE, p.PAGINATION, p.SOURCE, p.ISO as ISO_ABBREVIATION,</span>
<span class="s2">        p.JOURNAL_NAME_RAW as JOURNAL_TITLE, p.EIGENFACTOR, p.TYPE as ARTICLE_TYPE    </span>
<span class="s2">    FROM PREFIX_CORPUS as d</span>
<span class="s2">        INNER JOIN PREFIX_CORPUS_TO_PAPER as dp on (d.ID=dp.ID_CORPUS)</span>
<span class="s2">        INNER JOIN FIVETRAN.KG_RDS_CORE_DB.PAPER as p on (p.ID=dp.ID_PAPER)</span>
<span class="s2">  ) as P2 </span>
<span class="s2">  LEFT JOIN (SELECT PAPER_ID, F1000, FACEBOOK, MENDELEY, NEWS, REDDIT, TWITTER, WIKIPEDIA</span>
<span class="s2">      FROM PROD_DB.CORE_RAW.ALTMETRIC_IMPORT) V on P2.ID=V.PAPER_ID</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">DASHBOARD_BASIC_PAPER_COLUMNS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">,</span> <span class="s1">&#39;DOI&#39;</span><span class="p">,</span> <span class="s1">&#39;TITLE&#39;</span><span class="p">,</span> <span class="s1">&#39;ABSTRACT&#39;</span><span class="p">,</span> 
                                 <span class="s1">&#39;YEAR&#39;</span><span class="p">,</span> <span class="s1">&#39;MONTH&#39;</span><span class="p">,</span> <span class="s1">&#39;VOLUME&#39;</span><span class="p">,</span> 
                                 <span class="s1">&#39;ISSUE&#39;</span><span class="p">,</span> <span class="s1">&#39;MESH&#39;</span><span class="p">,</span> <span class="s1">&#39;PAGINATION&#39;</span><span class="p">,</span> 
                                 <span class="s1">&#39;JOURNAL_TITLE&#39;</span><span class="p">,</span> <span class="s1">&#39;ARTICLE_TYPE&#39;</span><span class="p">]</span>
<span class="n">DASHBOARD_BASIC_PAPER</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">SELECT DISTINCT p.id AS ID, p.DOI, p.TITLE, p.ABSTRACT, p.YEAR, p.MONTH, </span>
<span class="s1">        p.VOLUME, p.ISSUE, p.MESH_TERMS_RAW as MESH, p.PAGINATION, </span>
<span class="s1">        p.JOURNAL_NAME_RAW as JOURNAL_TITLE, p.TYPE as ARTICLE_TYPE  </span>
<span class="s1">FROM PREFIX_CORPUS as d</span>
<span class="s1">      JOIN PREFIX_CORPUS_TO_PAPER as dp on (d.ID=dp.ID_CORPUS)</span>
<span class="s1">      JOIN FIVETRAN.KG_RDS_CORE_DB.PAPER as p on (p.ID=dp.ID_PAPER)</span>
<span class="s1">&#39;&#39;&#39;</span>

<span class="n">DASHBOARD_PAPER_TO_AUTHOR</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT DISTINCT pa.*</span>
<span class="s2">FROM PREFIX_CORPUS_TO_PAPER as dp </span>
<span class="s2">    JOIN FIVETRAN.KG_RDS_CORE_DB.PAPER as p ON (p.ID=dp.ID_PAPER)</span>
<span class="s2">    JOIN FIVETRAN.KG_RDS_CORE_DB.PAPER_TO_AUTHOR_V2 as pa ON (p.ID=pa.ID_PAPER)</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">DASHBOARD_AUTHOR</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT DISTINCT a.id as ID, a.id_orcid as ID_ORCID, a.NAME as NAME, a.SOURCE as SOURCE, </span>
<span class="s2">    zeroifnull(sum(alt.MENDELEY)) as MENDELEY, zeroifnull(SUM(alt.TWITTER)) as TWITTER</span>
<span class="s2">FROM (SELECT DISTINCT ID_PAPER FROM PREFIX_CORPUS_TO_PAPER) as dp </span>
<span class="s2">    JOIN FIVETRAN.KG_RDS_CORE_DB.PAPER as p ON (p.ID=dp.ID_PAPER)</span>
<span class="s2">    JOIN FIVETRAN.KG_RDS_CORE_DB.PAPER_TO_AUTHOR_V2 as pa ON (p.ID=pa.ID_PAPER)</span>
<span class="s2">    JOIN FIVETRAN.KG_RDS_CORE_DB.AUTHOR_V2 as a ON (a.ID=pa.ID_AUTHOR) </span>
<span class="s2">    LEFT JOIN (SELECT PAPER_ID, F1000, FACEBOOK, MENDELEY, NEWS, REDDIT, TWITTER, WIKIPEDIA</span>
<span class="s2">      FROM PROD_DB.CORE_RAW.ALTMETRIC_IMPORT) alt on p.ID=alt.PAPER_ID</span>
<span class="s2">GROUP BY a.ID, a.id_orcid, a.NAME, a.SOURCE</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">DASHBOARD_PAPER_NOTES</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT p.id as PMID,</span>
<span class="s2">  LISTAGG(a.name, &#39;, &#39;) WITHIN GROUP (order by author_index) as AUTHOR_STRING,</span>
<span class="s2">  COUNT(a.name) as AUTHOR_COUNT </span>
<span class="s2">FROM (SELECT DISTINCT ID_PAPER FROM PREFIX_CORPUS_TO_PAPER) as dp </span>
<span class="s2">    JOIN FIVETRAN.KG_RDS_CORE_DB.PAPER as p ON (p.ID=dp.ID_PAPER)</span>
<span class="s2">    JOIN FIVETRAN.KG_RDS_CORE_DB.PAPER_TO_AUTHOR_V2 as pa ON (p.ID=pa.ID_PAPER)</span>
<span class="s2">    JOIN FIVETRAN.KG_RDS_CORE_DB.AUTHOR_V2 as a ON (a.ID=pa.ID_AUTHOR) </span>
<span class="s2">GROUP BY p.id ;</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">BUILD_DASHBOARD_PAPER_NOTES</span> <span class="o">=</span> <span class="s2">&quot;create table PREFIX_PAPER_NOTES as &quot;</span> <span class="o">+</span> <span class="n">DASHBOARD_PAPER_NOTES</span>

<span class="n">DASHBOARD_PAPER_OPEN_ACCESS</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT p.id as PMID, uu.license, uu.open_access </span>
<span class="s2">FROM (SELECT DISTINCT ID_PAPER FROM PREFIX_CORPUS_TO_PAPER) as dp </span>
<span class="s2">    JOIN FIVETRAN.KG_RDS_CORE_DB.PAPER as p ON (p.ID=dp.ID_PAPER)</span>
<span class="s2">    JOIN FIVETRAN.KG_RDS_CORE_DB.UNPAYWALL_URLS as uu on (p.DOI=uu.DOI)</span>
<span class="s2">GROUP BY p.id, uu.license, uu.open_access;</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">BUILD_DASHBOARD_PAPER_OPEN_ACCESS</span> <span class="o">=</span> <span class="s2">&quot;create table PREFIX_PAPER_OPEN_ACCESS as &quot;</span> <span class="o">+</span> <span class="n">DASHBOARD_PAPER_OPEN_ACCESS</span>


<span class="n">DASHBOARD_AFFILIATION</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT aff.* </span>
<span class="s2">FROM PREFIX_CORPUS_TO_PAPER as dp </span>
<span class="s2">    JOIN FIVETRAN.KG_RDS_CORE_DB.PAPER as p ON (p.ID=dp.ID_PAPER)</span>
<span class="s2">    JOIN FIVETRAN.KG_RDS_CORE_DB.AFFILIATION aff ON (p.ID = aff.ID_PAPER)</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">DASHBOARD_INSTITUTION</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">select i.*, r.PLACE_LATITUDE as latitude, r.PLACE_LONGITUDE as longitude </span>
<span class="s2">from PREFIX_CORPUS_TO_PAPER as dp </span>
<span class="s2">    JOIN FIVETRAN.KG_RDS_CORE_DB.PAPER as p ON (p.ID=dp.ID_PAPER)</span>
<span class="s2">    JOIN FIVETRAN.KG_RDS_CORE_DB.AFFILIATION aff ON (p.ID = aff.ID_PAPER)</span>
<span class="s2">    JOIN FIVETRAN.KG_RDS_CORE_DB.INSTITUTION i ON (i.ID = aff.ID_INSTITUTION)</span>
<span class="s2">    JOIN DEV_DB.SKE.RINGGOLD_LAT_LONG as r ON (i.id_source=r.ringgold_id )</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">DASHBOARD_PAPER_TO_CONCEPT</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT pc.* </span>
<span class="s2">FROM PREFIX_CORPUS_TO_PAPER as dp </span>
<span class="s2">    JOIN FIVETRAN.KG_RDS_CORE_DB.PAPER as p ON (p.ID=dp.ID_PAPER)</span>
<span class="s2">    JOIN FIVETRAN.KG_RDS_CORE_DB.PAPER_TO_CONCEPT pc ON (p.ID=pc.ID_PAPER)</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">DASHBOARD_CONCEPT</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT c.* </span>
<span class="s2">FROM PREFIX_CORPUS_TO_PAPER as dp </span>
<span class="s2">    JOIN FIVETRAN.KG_RDS_CORE_DB.PAPER as p ON (p.ID=dp.ID_PAPER)</span>
<span class="s2">    JOIN FIVETRAN.KG_RDS_CORE_DB.PAPER_TO_CONCEPT pc ON (p.ID=pc.ID_PAPER)</span>
<span class="s2">    JOIN FIVETRAN.KG_RDS_CORE_DB.CONCEPT c ON (c.ID=pc.ID_CONCEPT)</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">DASHBOARD_CONCEPT_TO_SEMANTIC_TYPE</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT cst.* </span>
<span class="s2">FROM PREFIX_CORPUS_TO_PAPER as dp </span>
<span class="s2">    JOIN FIVETRAN.KG_RDS_CORE_DB.PAPER as p ON (p.ID=dp.ID_PAPER)</span>
<span class="s2">    JOIN FIVETRAN.KG_RDS_CORE_DB.PAPER_TO_CONCEPT pc ON (p.ID=pc.ID_PAPER)</span>
<span class="s2">    JOIN FIVETRAN.KG_RDS_CORE_DB.CONCEPT_TO_SEMANTIC_TYPE cst ON (pc.ID_CONCEPT=cst.ID_CONCEPT)</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">DASHBOARD_SEMANTIC_TYPE</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT st.* </span>
<span class="s2">FROM DEV_DB.SKE.SEMANTIC_TYPES_CATEGORIES as st</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">DASHBOARD_COLLABORATIONS</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT DISTINCT id_author_a, id_author_b, id_paper as id_paper, author_count as author_count </span>
<span class="s2">FROM </span>
<span class="s2">    (select distinct a.id_author as id_author_a, b.id_author_b, a.id_paper, b.author_count </span>
<span class="s2">    from RARE_CORPUS_TO_PAPER as cp </span>
<span class="s2">    JOIN FIVETRAN.KG_RDS_CORE_DB.PAPER_TO_AUTHOR_V2 a on (cp.ID_PAPER=a.ID_PAPER)</span>
<span class="s2">    left join </span>
<span class="s2">        (select pa1.id_author as id_author_b, pa1.id_paper as id_paper, COUNT(pa2.id_author) as author_count </span>
<span class="s2">        from RARE_CORPUS_TO_PAPER as cp </span>
<span class="s2">        JOIN FIVETRAN.KG_RDS_CORE_DB.PAPER_TO_AUTHOR_V2 pa1 on (cp.ID_PAPER=pa1.ID_PAPER)</span>
<span class="s2">        JOIN FIVETRAN.KG_RDS_CORE_DB.PAPER_TO_AUTHOR_V2 pa2 on (pa1.ID_PAPER=pa2.ID_PAPER)</span>
<span class="s2">        GROUP BY pa1.id_author, pa1.id_paper) b on a.id_paper=b.id_paper </span>
<span class="s2">    where id_author_a &gt; id_author_b </span>
<span class="s2">    order by a.id_paper, id_author_a) </span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">BUILD_DASHBOARD_COLLABORATIONS</span> <span class="o">=</span> <span class="s2">&quot;create table PREFIX_COLLABORATIONS as &quot;</span> <span class="o">+</span> <span class="n">DASHBOARD_COLLABORATIONS</span>

<span class="n">DASHBOARD_AUTHOR_LOCATION</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">SELECT DISTINCT</span>
<span class="s1">    a.id as author_id, a.name as author_name, ordered_locations.REV_ORDER, ordered_locations.institution, </span>
<span class="s1">    ordered_locations.city, ordered_locations.country, ordered_locations.lat, ordered_locations.long</span>
<span class="s1">FROM PREFIX_CORPUS_TO_PAPER as cp </span>
<span class="s1">    JOIN FIVETRAN.KG_RDS_CORE_DB.PAPER_TO_AUTHOR_V2 pa on (cp.ID_PAPER=pa.ID_PAPER)</span>
<span class="s1">    JOIN FIVETRAN.KG_RDS_CORE_DB.AUTHOR_V2 AS a on (pa.ID_AUTHOR=a.ID)</span>
<span class="s1">        JOIN (</span>
<span class="s1">          SELECT p2a.ID_AUTHOR as ID_AUTHOR, </span>
<span class="s1">                p.YEAR as YEAR, </span>
<span class="s1">                rank() over (partition by p2a.ID_AUTHOR order by p.PMID desc, i.name) as REV_ORDER,</span>
<span class="s1">                i.name as institution, i.city as city, i.country as country, rll.PLACE_LATITUDE as lat, rll.PLACE_LONGITUDE as long</span>
<span class="s1">          FROM PREFIX_CORPUS_TO_PAPER as cp </span>
<span class="s1">            JOIN FIVETRAN.KG_RDS_CORE_DB.PAPER_TO_AUTHOR_V2 p2a on (cp.ID_PAPER=p2a.ID_PAPER)</span>
<span class="s1">            JOIN FIVETRAN.KG_RDS_CORE_DB.PAPER AS p ON (p2a.ID_PAPER = p.ID)</span>
<span class="s1">            JOIN FIVETRAN.KG_RDS_CORE_DB.AFFILIATION AS aff ON (p2a.id_paper=aff.id_paper AND p2a.author_index=aff.index_author)</span>
<span class="s1">            JOIN FIVETRAN.KG_RDS_CORE_DB.INSTITUTION AS i ON (aff.id_institution = i.id)</span>
<span class="s1">            JOIN DEV_DB.SKE.RINGGOLD_LAT_LONG AS rll ON (rll.ringgold_id = i.id_source)</span>
<span class="s1">         ORDER BY id_author, REV_ORDER</span>
<span class="s1">        ) AS ordered_locations on (ordered_locations.ID_AUTHOR=a.id)</span>
<span class="s1">WHERE ordered_locations.REV_ORDER=1</span>
<span class="s1">GROUP BY author_id, author_name, REV_ORDER, year, institution, lat, long, city, country</span>
<span class="s1">ORDER BY author_name, REV_ORDER;</span>
<span class="s1">&#39;&#39;&#39;</span>
<span class="n">BUILD_DASHBOARD_AUTHOR_LOCATION</span> <span class="o">=</span> <span class="s2">&quot;create table PREFIX_AUTHOR_LOCATION as &quot;</span> <span class="o">+</span> <span class="n">DASHBOARD_AUTHOR_LOCATION</span>

<span class="n">DASHBOARD_CITATION_COUNTS</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">        select p.id as ID, cit.DOI_TO_PAPER as DOI, COUNT(cit.ID) as CITATION_COUNT </span>
<span class="s1">        from PREFIX_CORPUS_TO_PAPER as cp </span>
<span class="s1">            JOIN FIVETRAN.KG_RDS_CORE_DB.PAPER as p ON (cp.ID_PAPER=p.ID)</span>
<span class="s1">            JOIN FIVETRAN.KG_RDS_CORE_DB.CITATION as cit ON (cit.DOI_TO_PAPER=p.DOI) </span>
<span class="s1">        where DOI != &#39;&#39;</span>
<span class="s1">        group by p.id, cit.DOI_TO_PAPER;</span>
<span class="s1">&#39;&#39;&#39;</span>
<span class="n">BUILD_DASHBOARD_CITATION_COUNTS</span> <span class="o">=</span> <span class="s1">&#39;create table PREFIX_CITATION_COUNTS as &#39;</span> <span class="o">+</span> <span class="n">DASHBOARD_CITATION_COUNTS</span>

<span class="n">ADD_SEMANTIC_TYPES_TO_FILTER_CONCEPTS</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">DASHBOARD_CURATED_DATA</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">        select p.id as ID_PAPER, cit.DOI_TO_PAPER as DOI, COUNT(cit.ID) as CITATION_COUNT </span>
<span class="s1">        from PREFIX_CORPUS_TO_PAPER as cp </span>
<span class="s1">            JOIN PREFIX_FIVETRAN.KG_RDS_CORE_DB.PAPER as p ON (cp.ID_PAPER=p.ID)</span>
<span class="s1">            JOIN FIVETRAN.KG_RDS_CORE_DB.CITATION as cit ON (cit.DOI_TO_PAPER=p.DOI) </span>
<span class="s1">        where DOI != &#39;&#39;</span>
<span class="s1">        group by p.id, cit.DOI_TO_PAPER;</span>
<span class="s1">&#39;&#39;&#39;</span>
<span class="n">BUILD_DASHBOARD_CITATION_COUNTS</span> <span class="o">=</span> <span class="s1">&#39;create table PREFIX_CITATION_COUNTS as &#39;</span> <span class="o">+</span> <span class="n">DASHBOARD_CITATION_COUNTS</span>


<span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="c1"># PRIMARILY NOTES TO ALLOW US TO RECORD HOW QUERIES WERE PERFORMED ON THE DASHBOARD</span>

<span class="n">DASH_CORPUS_SQL</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;SELECT CORPUS_NAME </span>
<span class="s1">FROM PREFIX_CORPUS as d</span>
<span class="s1">&#39;&#39;&#39;</span>

<span class="n">DASH_PAPER_COUNT_SQL</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;SELECT DISTINCT COUNT(p.id) AS PAPER_COUNT, dp.SUBSET_CODE AS SUBSET, CORPUS_NAME, d.ID</span>
<span class="s1">FROM PREFIX_CORPUS as d</span>
<span class="s1">    JOIN PREFIX_CORPUS_TO_PAPER as dp on (d.ID=dp.ID_CORPUS)</span>
<span class="s1">    JOIN FIVETRAN.KG_RDS_CORE_DB.PAPER as p on (p.ID=dp.ID_PAPER)</span>
<span class="s1">GROUP BY CORPUS_NAME, SUBSET, d.ID </span>
<span class="s1">&#39;&#39;&#39;</span>
<span class="n">CREATE_DASH_PAPER_COUNT</span> <span class="o">=</span> <span class="s1">&#39;create table PREFIX_DASH_PAPER_COUNT as select * from </span><span class="se">\n</span><span class="s1">(</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">DASH_PAPER_COUNT_SQL</span><span class="p">)</span>

<span class="n">DASH_OA_PAPER_COUNT_SQL</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;SELECT DISTINCT COUNT(DISTINCT p.id) AS OA_PAPER_COUNT, dp.SUBSET_CODE AS SUBSET, CORPUS_NAME, d.ID</span>
<span class="s1">FROM PREFIX_CORPUS as d</span>
<span class="s1">    JOIN PREFIX_CORPUS_TO_PAPER as dp on (d.ID=dp.ID_CORPUS)</span>
<span class="s1">    JOIN FIVETRAN.KG_RDS_CORE_DB.PAPER as p on (p.ID=dp.ID_PAPER)</span>
<span class="s1">    JOIN FIVETRAN.KG_RDS_CORE_DB.UNPAYWALL_URLS as uu on (p.DOI=uu.DOI)</span>
<span class="s1">WHERE uu.open_access is not null</span>
<span class="s1">GROUP BY CORPUS_NAME, SUBSET, d.ID  </span>
<span class="s1">&#39;&#39;&#39;</span>
<span class="n">CREATE_DASH_OA_PAPER_COUNT</span> <span class="o">=</span> <span class="s1">&#39;create table PREFIX_DASH_OA_PAPER_COUNT as select * from </span><span class="se">\n</span><span class="s1">(</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">DASH_OA_PAPER_COUNT_SQL</span><span class="p">)</span>

<span class="n">DASH_AUTHOR_COUNT_SQL</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;SELECT count(DISTINCT a.id) AS AUTHOR_COUNT, dp.SUBSET_CODE AS SUBSET, CORPUS_NAME, d.ID</span>
<span class="s1">FROM PREFIX_CORPUS as d</span>
<span class="s1">    INNER JOIN PREFIX_CORPUS_TO_PAPER as dp on (d.ID=dp.ID_CORPUS)  </span>
<span class="s1">    INNER JOIN FIVETRAN.KG_RDS_CORE_DB.PAPER as p on (p.ID=dp.ID_PAPER)</span>
<span class="s1">    INNER JOIN FIVETRAN.KG_RDS_CORE_DB.PAPER_TO_AUTHOR_V2 as pa on (p.ID=pa.ID_PAPER)  </span>
<span class="s1">    INNER JOIN FIVETRAN.KG_RDS_CORE_DB.AUTHOR_V2 as a on (a.ID=pa.ID_AUTHOR)</span>
<span class="s1">GROUP BY CORPUS_NAME, SUBSET, d.ID </span>
<span class="s1">&#39;&#39;&#39;</span>
<span class="n">CREATE_DASH_AUTHOR_COUNT_SQL</span> <span class="o">=</span> <span class="s1">&#39;create table PREFIX_DASH_AUTHOR_COUNT as select * from </span><span class="se">\n</span><span class="s1">(</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">DASH_AUTHOR_COUNT_SQL</span><span class="p">)</span>

<span class="n">DASH_AUTHOR_SQL</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;select distinct a.id, </span>
<span class="s1">        a.id_orcid, </span>
<span class="s1">        a.name as author_name, </span>
<span class="s1">        sum(ZEROIFNULL(cc.citation_count)/(2021-p.year)) as normalized_citation_count,  </span>
<span class="s1">        zeroifnull(sum(alt.MENDELEY)) as Mendeley, </span>
<span class="s1">        zeroifnull(SUM(alt.TWITTER)) as Twitter,</span>
<span class="s1">        loc.institution as Institution,</span>
<span class="s1">        loc.city as City,</span>
<span class="s1">        loc.country as Country,</span>
<span class="s1">        DENSE_RANK() OVER (PARTITION BY CORPUS_NAME ORDER BY normalized_citation_count DESC, a.id, a.id_orcid, a.name, loc.institution DESC) as RANK,</span>
<span class="s1">        CORPUS_NAME,</span>
<span class="s1">        dop.SUBSET_CODE as SUBSET</span>
<span class="s1">    from PREFIX_CORPUS_TO_PAPER as dop </span>
<span class="s1">        JOIN PREFIX_CORPUS as do on (dop.id_corpus=do.id)</span>
<span class="s1">        JOIN FIVETRAN.KG_RDS_CORE_DB.PAPER_TO_AUTHOR_V2 as pa on (dop.id_paper=pa.id_paper)</span>
<span class="s1">        JOIN FIVETRAN.KG_RDS_CORE_DB.PAPER as p on (pa.id_paper=p.id)</span>
<span class="s1">        JOIN PROD_DB.CORE_RAW.ALTMETRIC_IMPORT AS alt on (p.id=alt.paper_id)</span>
<span class="s1">        JOIN FIVETRAN.KG_RDS_CORE_DB.AUTHOR_V2 as a on (pa.id_author=a.id)</span>
<span class="s1">        JOIN PREFIX_CITATION_COUNTS as cc on (dop.ID_PAPER=cc.id)</span>
<span class="s1">        LEFT JOIN PREFIX_AUTHOR_LOCATION as loc on (a.id=loc.author_id)    </span>
<span class="s1">    group by a.id, a.id_orcid, a.name, alt.Mendeley, alt.Twitter, loc.Institution, loc.City, loc.Country, CORPUS_NAME, SUBSET</span>
<span class="s1">    order by Twitter desc</span>
<span class="s1">&#39;&#39;&#39;</span>
<span class="n">CREATE_DASH_AUTHOR_SQL</span> <span class="o">=</span> <span class="s1">&#39;create table PREFIX_DASH_AUTHOR as select * from </span><span class="se">\n</span><span class="s1">(</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">DASH_AUTHOR_SQL</span><span class="p">)</span>

<span class="n">DASH_PAPERS_SQL</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;    </span>
<span class="s1">    SELECT DISTINCT p.id as PMID, </span>
<span class="s1">        ZEROIFNULL(cc.CITATION_COUNT) as N_CITATIONS,</span>
<span class="s1">        alt.MENDELEY,</span>
<span class="s1">        alt.TWITTER,</span>
<span class="s1">        pas.author_string as AUTHORS,</span>
<span class="s1">        pas.open_access as open_access,</span>
<span class="s1">        YEAR AS YEAR,</span>
<span class="s1">        TITLE, </span>
<span class="s1">        ABSTRACT,</span>
<span class="s1">        CONCAT(JOURNAL_NAME_RAW, &#39; &#39;, p.VOLUME ,&#39;:&#39;,p.PAGINATION) as Journal_Ref,</span>
<span class="s1">        REPLACE(REGEXP_REPLACE( p.TYPE, &#39;Research Support,.*?($|\|)&#39;, &#39;</span><span class="se">\\</span><span class="s1">1&#39; ), &#39;|&#39;, &#39;; &#39;) AS Type,  </span>
<span class="s1">        DENSE_RANK() OVER (PARTITION BY CORPUS_NAME ORDER BY N_CITATIONS DESC) AS RANK,</span>
<span class="s1">        CORPUS_NAME,</span>
<span class="s1">        dp.SUBSET_CODE as SUBSET</span>
<span class="s1">    FROM PREFIX_CORPUS as d </span>
<span class="s1">        JOIN PREFIX_CORPUS_TO_PAPER as dp on (d.ID=dp.ID_CORPUS) </span>
<span class="s1">        JOIN FIVETRAN.KG_RDS_CORE_DB.PAPER as p on (p.ID=dp.ID_PAPER)</span>
<span class="s1">        LEFT JOIN PROD_DB.CORE_RAW.ALTMETRIC_IMPORT AS alt on (p.id=alt.paper_id)</span>
<span class="s1">        LEFT JOIN PREFIX_CITATION_COUNTS as cc on (p.ID=cc.id)</span>
<span class="s1">        JOIN PREFIX_PAPER_NOTES as pas on (p.ID=pas.PMID)</span>
<span class="s1">        JOIN FIVETRAN.KG_RDS_CORE_DB.PAPER_TO_AUTHOR_V2 as pa on p.ID=pa.ID_PAPER</span>
<span class="s1">        JOIN FIVETRAN.KG_RDS_CORE_DB.AUTHOR_V2 as a on (a.ID=pa.ID_AUTHOR)</span>
<span class="s1">    ORDER BY CORPUS_NAME, SUBSET, N_CITATIONS DESC</span>
<span class="s1">&#39;&#39;&#39;</span>
<span class="n">CREATE_DASH_PAPERS_SQL</span> <span class="o">=</span> <span class="s1">&#39;create table PREFIX_DASH_PAPERS as select * from </span><span class="se">\n</span><span class="s1">(</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">DASH_PAPERS_SQL</span><span class="p">)</span>

<span class="n">DASH_CONCEPTS_COLUMNS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;CONCEPT&#39;</span><span class="p">,</span> <span class="s1">&#39;PAPER_COUNT&#39;</span><span class="p">,</span> <span class="s1">&#39;SEMTYPES&#39;</span><span class="p">,</span> <span class="s1">&#39;CORPUS_NAME&#39;</span><span class="p">]</span>
<span class="n">DASH_CONCEPTS_SQL</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;SELECT e.NAME AS CONCEPT, </span>
<span class="s1">    count(distinct c.ID) AS PAPER_COUNT, </span>
<span class="s1">    f.semtypes AS SEMTYPES,</span>
<span class="s1">    CORPUS_NAME,</span>
<span class="s1">    b.SUBSET_CODE as SUBSET</span>
<span class="s1">FROM PREFIX_CORPUS as a</span>
<span class="s1">    JOIN PREFIX_CORPUS_TO_PAPER as b on (a.ID = b.ID_CORPUS)</span>
<span class="s1">    JOIN FIVETRAN.KG_RDS_CORE_DB.PAPER as c on (b.ID_PAPER = c.ID)</span>
<span class="s1">    JOIN FIVETRAN.KG_RDS_CORE_DB.PAPER_TO_CONCEPT as d on (c.ID = d.ID_PAPER) </span>
<span class="s1">    JOIN FIVETRAN.KG_RDS_CORE_DB.CONCEPT as e on (d.ID_CONCEPT = e.ID)  </span>
<span class="s1">    JOIN (</span>
<span class="s1">      SELECT concept_id, LISTAGG(semtype, &#39;; &#39;) as semtypes </span>
<span class="s1">      FROM (</span>
<span class="s1">        SELECT DISTINCT x.ID_CONCEPT as concept_id, y.NAME as semtype </span>
<span class="s1">          FROM FIVETRAN.KG_RDS_CORE_DB.CONCEPT_TO_SEMANTIC_TYPE as x</span>
<span class="s1">            JOIN FIVETRAN.KG_RDS_CORE_DB.SEMANTIC_TYPE as y on (x.ID_SEMANTIC_TYPE = y.ID)</span>
<span class="s1">      )</span>
<span class="s1">      GROUP BY concept_id) as f on (e.ID = f.concept_id)</span>
<span class="s1">GROUP BY e.NAME, f.semtypes, CORPUS_NAME, SUBSET</span>
<span class="s1">ORDER BY count(distinct c.ID) DESC</span>
<span class="s1">&#39;&#39;&#39;</span>
<span class="n">CREATE_DASH_CONCEPTS_SQL</span> <span class="o">=</span> <span class="s1">&#39;create table PREFIX_DASH_CONCEPTS as select * from </span><span class="se">\n</span><span class="s1">(</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">DASH_CONCEPTS_SQL</span><span class="p">)</span>

<span class="n">DASH_GEO_MAP_SQL</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;select distinct </span>
<span class="s1">        institute.NAME as NAME,</span>
<span class="s1">        institute.CITY as CITY,        </span>
<span class="s1">        institute.COUNTRY as COUNTRY,</span>
<span class="s1">        institute.LATITUDE as LATITUDE,</span>
<span class="s1">        institute.LONGITUDE as LONGITUDE,</span>
<span class="s1">        sum(institute.C_COUNT) as C_COUNT, </span>
<span class="s1">        CONCAT(&#39;Count of Citations: &#39;, sum(institute.C_COUNT)) as CITATION_COUNT, </span>
<span class="s1">        LISTAGG(institute.author_list, &#39;; &#39;) as LIST, </span>
<span class="s1">        CORPUS_NAME,</span>
<span class="s1">        dop.SUBSET_CODE as SUBSET,</span>
<span class="s1">        DENSE_RANK() OVER (PARTITION BY CORPUS_NAME ORDER BY &quot;C_COUNT&quot; DESC) AS &quot;Rank&quot;</span>
<span class="s1">    from </span>
<span class="s1">        (SELECT loc.institution as NAME,</span>
<span class="s1">              loc.city as CITY,        </span>
<span class="s1">              loc.country as COUNTRY,</span>
<span class="s1">              loc.lat as LATITUDE,</span>
<span class="s1">              loc.long as LONGITUDE,</span>
<span class="s1">              ZEROIFNULL( cc.citation_count) as C_COUNT,</span>
<span class="s1">              p.id as id_paper,</span>
<span class="s1">              LISTAGG(DISTINCT a.name, &#39;; &#39;) as author_list</span>
<span class="s1">          FROM PREFIX_AUTHOR_LOCATION as loc </span>
<span class="s1">              JOIN FIVETRAN.KG_RDS_CORE_DB.AUTHOR_V2 as a on (a.id=loc.author_id) </span>
<span class="s1">              JOIN FIVETRAN.KG_RDS_CORE_DB.PAPER_TO_AUTHOR_V2 as pa on (pa.id_author=a.id) </span>
<span class="s1">              JOIN FIVETRAN.KG_RDS_CORE_DB.PAPER as p on (pa.id_paper=p.id)</span>
<span class="s1">              JOIN PREFIX_CITATION_COUNTS as cc on (p.id=cc.id)</span>
<span class="s1">          group by loc.institution, loc.CITY, loc.COUNTRY, LATITUDE, LONGITUDE, p.id, C_COUNT</span>
<span class="s1">        ) as institute </span>
<span class="s1">        JOIN PREFIX_CORPUS_TO_PAPER as dop on (dop.id_paper=institute.id_paper)</span>
<span class="s1">        JOIN PREFIX_CORPUS as do on (dop.id_corpus=do.id)</span>
<span class="s1">    GROUP BY institute.NAME, institute.CITY, institute.COUNTRY, institute.LATITUDE, institute.LONGITUDE, C_COUNT, CORPUS_NAME, SUBSET</span>
<span class="s1">    ORDER BY &quot;Rank&quot;</span>
<span class="s1">&#39;&#39;&#39;</span>
<span class="n">CREATE_DASH_GEO_MAP_SQL</span> <span class="o">=</span> <span class="s1">&#39;create table PREFIX_DASH_GEO_MAP as select * from </span><span class="se">\n</span><span class="s1">(</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">DASH_GEO_MAP_SQL</span><span class="p">)</span>

<span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>

<span class="n">CONTENT_CORPUS_SQL</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;SELECT DISTINCT p.id as PMID, </span>
<span class="s1">        YEAR AS YEAR,</span>
<span class="s1">        TITLE, </span>
<span class="s1">        ABSTRACT, </span>
<span class="s1">        JOURNAL_NAME_RAW as Journal,</span>
<span class="s1">        CORPUS_NAME</span>
<span class="s1">    FROM PREFIX_CORPUS as d </span>
<span class="s1">        JOIN PREFIX_CORPUS_TO_PAPER as dp on (d.ID=dp.ID_CORPUS) </span>
<span class="s1">        JOIN FIVETRAN.KG_RDS_CORE_DB.PAPER as p on (p.ID=dp.ID_PAPER)</span>
<span class="s1">    WHERE dp.SUBSET_CODE=NULL</span>
<span class="s1">    ORDER BY N_CITATIONS DESC</span>
<span class="s1">&#39;&#39;&#39;</span>
<span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>

<span class="n">MONDO_SEARCH_TERMS</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">&#39;&#39;&#39;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">CREATE_FULL_TEXT_DOCUMENT_TABLE</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    CREATE TABLE FULLTEXT_DOCUMENT (ID INT IDENTITY, </span>
<span class="s2">        ID_FTD TEXT, </span>
<span class="s2">        PLAIN_TEXT TEXT,</span>
<span class="s2">        ENCODING TEXT, </span>
<span class="s2">        PROVENANCE TEXT );</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">CREATE_FULL_TEXT_ANNOTATION_TABLE</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    CREATE TABLE FULLTEXT_ANNOTATION (</span>
<span class="s2">        ID INT IDENTITY, </span>
<span class="s2">        LOCAL_ID TEXT,</span>
<span class="s2">        ID_FTD TEXT, </span>
<span class="s2">        START_SPAN INT, </span>
<span class="s2">        END_SPAN INT,</span>
<span class="s2">        TYPE TEXT, </span>
<span class="s2">        TAG TEXT, </span>
<span class="s2">        ATTR TEXT,</span>
<span class="s2">        SANITY_CHECK TEXT);</span>
<span class="s2">&quot;&quot;&quot;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

