---

title: Disease Research State Model  


keywords: fastai
sidebar: home_sidebar

summary: "Classes and functions to execute functionality for generating and analyzing the state of research into one or many identified diseases"
description: "Classes and functions to execute functionality for generating and analyzing the state of research into one or many identified diseases"
nb_path: "nbdev/utils/11_disease_research_state_model.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbdev/utils/11_disease_research_state_model.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">activesoup</span>
<span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span><span class="p">,</span><span class="n">Tag</span><span class="p">,</span><span class="n">Comment</span><span class="p">,</span><span class="n">NavigableString</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">import</span> <span class="nn">json</span> 
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">owlready2</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">prophet.serialize</span> <span class="kn">import</span> <span class="n">model_to_json</span><span class="p">,</span> <span class="n">model_from_json</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">scipy.spatial.distance</span> <span class="kn">import</span> <span class="n">cdist</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span><span class="p">,</span><span class="n">sleep</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="n">urlopen</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">quote_plus</span><span class="p">,</span> <span class="n">quote</span><span class="p">,</span> <span class="n">unquote</span>
<span class="kn">from</span> <span class="nn">urllib.error</span> <span class="kn">import</span> <span class="n">URLError</span>

<span class="k">class</span> <span class="nc">DRSMCollection</span><span class="p">():</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;This class generates and supports analysis the research landscape over a collection of diseases. </span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">study_name</span><span class="p">,</span> <span class="n">corpora_df</span><span class="p">,</span> <span class="n">name_col</span><span class="o">=</span><span class="s1">&#39;CORPUS_NAME&#39;</span><span class="p">,</span> <span class="n">mondo_col</span><span class="o">=</span><span class="s1">&#39;MONDO_CURI&#39;</span><span class="p">,</span> <span class="n">query_col</span><span class="o">=</span><span class="s1">&#39;QUERY&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Initializes the DRSM Collection object.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">study_name</span> <span class="o">=</span> <span class="n">name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">corpora_df</span> <span class="o">=</span> <span class="n">corpora_df</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">name_col</span> <span class="o">=</span> <span class="n">name_col</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">query_col</span> <span class="o">=</span> <span class="n">query_col</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mondo_col</span> <span class="o">=</span> <span class="n">mondo_col</span>
    
  <span class="k">def</span> <span class="nf">check_query_phrase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phrase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks whether a single phrase would work on Pubmed or would be expanded (which can lead to unpredictable errors). </span>
<span class="sd">    Use this as a check for synonyms.   </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">idPrefix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">phrase</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">phrase</span><span class="p">)</span>
    <span class="n">m1</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;^[a-zA-Z0-9]{1,5}$&#39;</span><span class="p">,</span> <span class="n">phrase</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">phrase</span> <span class="o">+</span> <span class="s1">&#39;: Abbreviation&#39;</span><span class="p">,</span> <span class="mi">0</span>

    <span class="n">m2</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;[(\)]&#39;</span><span class="p">,</span> <span class="n">phrase</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">phrase</span><span class="o">+</span><span class="s1">&#39;: Brackets&#39;</span><span class="p">,</span> <span class="mi">0</span>

    <span class="n">m3</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;[\,\;]&#39;</span><span class="p">,</span> <span class="n">phrase</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m3</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">phrase</span> <span class="o">=</span> <span class="s1">&#39;(&quot;&#39;</span> <span class="o">+</span> <span class="s1">&#39;&quot; AND &quot;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;[\,\;]&#39;</span><span class="p">,</span> <span class="n">phrase</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span><span class="o">+</span><span class="s1">&#39;&quot;)&#39;</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> 
      <span class="n">esearch_stem</span> <span class="o">=</span> <span class="s1">&#39;https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi?api_key=&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="o">+</span><span class="s1">&#39;&amp;db=&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">+</span> <span class="s1">&#39;&amp;term=&#39;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">esearch_stem</span> <span class="o">=</span> <span class="s1">&#39;https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi?db=&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">+</span> <span class="s1">&#39;&amp;term=&#39;</span>
    <span class="n">url</span> <span class="o">=</span>  <span class="n">esearch_stem</span> <span class="o">+</span> <span class="n">quote</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="o">+</span><span class="n">phrase</span><span class="o">+</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>

    <span class="c1">#print(url)</span>
    <span class="n">esearch_response</span> <span class="o">=</span> <span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="n">esearch_data</span> <span class="o">=</span> <span class="n">esearch_response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="n">esearch_soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">esearch_data</span><span class="p">,</span> <span class="s2">&quot;lxml-xml&quot;</span><span class="p">)</span>
    <span class="n">count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">esearch_soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;Count&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">string</span><span class="p">)</span>
    <span class="c1">#n_translations = len(esearch_soup.find(&#39;TranslationStack&#39;).findAll(&#39;TermSet&#39;))</span>
    <span class="n">phrase_not_found</span> <span class="o">=</span> <span class="n">esearch_soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;PhraseNotFound&#39;</span><span class="p">)</span>
    <span class="n">quoted_phrase_not_found</span> <span class="o">=</span> <span class="n">esearch_soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;QuotedPhraseNotFound&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">phrase_not_found</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">quoted_phrase_not_found</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span><span class="o">+</span><span class="n">phrase</span><span class="o">+</span><span class="s1">&#39;&quot; not found&#39;</span><span class="p">,</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
      <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">phrase</span><span class="p">,</span> <span class="n">count</span>
    <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">phrase</span><span class="p">,</span> <span class="n">count</span>        

  <span class="k">def</span> <span class="nf">build_query_tuples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">check_threshold</span><span class="p">,</span> <span class="n">name_col</span><span class="p">,</span> <span class="n">terms_col</span><span class="p">,</span> <span class="n">sep</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">query_tuples</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">phrase_counts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
      <span class="n">search_l</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="n">terms_to_check</span> <span class="o">=</span> <span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">name_col</span><span class="p">][</span><span class="n">ind</span><span class="p">]]</span>
      <span class="n">terms_to_check</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">terms_col</span><span class="p">][</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">))</span>
      <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">terms_to_check</span><span class="p">:</span> 
        <span class="n">go_no_go</span><span class="p">,</span> <span class="n">phrase</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="n">check_query_phrase</span><span class="p">(</span><span class="n">esq</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">go_no_go</span><span class="p">,</span> <span class="n">phrase</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">go_no_go</span><span class="p">:</span>
          <span class="n">search_l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phrase</span><span class="p">)</span>
          <span class="n">sleep</span><span class="p">(</span><span class="mf">0.10</span><span class="p">)</span>
          <span class="k">if</span> <span class="n">count</span><span class="o">&gt;</span><span class="n">check_threshold</span><span class="p">:</span>
            <span class="n">phrase_counts</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">phrase</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span>
      <span class="n">query_tuples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="n">name_col</span><span class="p">][</span><span class="n">ind</span><span class="p">],</span> <span class="s1">&#39; OR &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">search_l</span><span class="p">))</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">query_tuples</span><span class="p">,</span> <span class="n">phrase_counts</span>    


<span class="k">class</span> <span class="nc">DRSM</span><span class="p">():</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;This class provides a model of the state of research into a particular disease (&#39;Disease Research State Model&#39;) based on broad subtypes of research article present in the literature. It makes use of functionality within the CZ Landscaping Toolkit to search online sources, classify the data it finds, and run analyses over that data. </span>
<span class="sd">  </span>
<span class="sd">  This version is based on some assumptions: (1) data pertaining to a single disease is linked to an entry in a PREFIX_CORPUS table; (2) papers for that disease/corpus are indexed in the PREFIX_CORPUS_PAPERS table; (3) Codes denoting the type of each paper are stored in the PREFIX_DRSM table.  </span>
<span class="sd">  </span>
<span class="sd">  Note that the time series computation is also simply the difference between matched curves over the publishing timeframe of the analysis. </span>
<span class="sd">  &quot;&quot;&quot;</span>
  
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dashdb</span><span class="p">,</span> <span class="n">corpus_id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">mondo_id</span><span class="p">,</span> <span class="n">event_lines</span><span class="o">=</span><span class="p">[]):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Initializes the DRSM object.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dashdb</span> <span class="o">=</span> <span class="n">dashdb</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">corpus_id</span> <span class="o">=</span> <span class="n">corpus_id</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mondo_id</span> <span class="o">=</span> <span class="n">mondo_id</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">event_lines</span> <span class="o">=</span> <span class="n">event_lines</span>
    
  <span class="k">def</span> <span class="nf">build_trend_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Computes trend data from existing an underlying corpus of papers annotated for study categories </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;SELECT DISTINCT count(DISTINCT p.id) AS paper_count, d.ID, p.YEAR, p.MONTH, drsm.DRSM_LABEL</span>
<span class="s1">          FROM PREFIX_CORPUS as d</span>
<span class="s1">              JOIN PREFIX_CORPUS_TO_PAPER as dp on (d.ID=dp.ID_CORPUS)</span>
<span class="s1">              JOIN FIVETRAN.KG_RDS_CORE_DB.PAPER as p on (p.ID=dp.ID_PAPER)</span>
<span class="s1">              JOIN PREFIX_DRSM as drsm on (p.ID=drsm.ID_PAPER)</span>
<span class="s1">          WHERE d.ID=&#39;&#39;&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">corpus_id</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">          GROUP BY drsm.DRSM_LABEL, YEAR, MONTH, d.ID</span>
<span class="s1">          ORDER BY drsm.DRSM_LABEL, YEAR, MONTH&#39;&#39;&#39;</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;paper_count&#39;</span><span class="p">,</span> <span class="s1">&#39;CORPUS_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;YEAR&#39;</span><span class="p">,</span> <span class="s1">&#39;MONTH&#39;</span><span class="p">,</span> <span class="s1">&#39;DRSM_LABEL&#39;</span><span class="p">]</span>
    <span class="n">sql</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;PREFIX_&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dashdb</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">sql</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dashdb</span><span class="o">.</span><span class="n">execute_query</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">cols</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">YEAR</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">YEAR</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">MONTH</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">itertuples</span><span class="p">()]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;YEAR&#39;</span><span class="p">,</span> <span class="s1">&#39;MONTH&#39;</span><span class="p">])</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;irrelevant&#39;</span><span class="p">,</span><span class="s1">&#39;reviews&#39;</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">})</span>
    
    <span class="n">l</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">cat</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">DRSM_LABEL</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
      <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]),</span> <span class="nb">max</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]),</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;MS&#39;</span><span class="p">):</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">DRSM_LABEL</span><span class="o">==</span><span class="n">cat</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">date</span><span class="o">==</span><span class="n">d</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
          <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">cat</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">paper_count</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">cat</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">ts_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;drsm&#39;</span><span class="p">,</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="s1">&#39;paper_count&#39;</span><span class="p">])</span> 
    <span class="bp">self</span><span class="o">.</span><span class="n">raw_df</span> <span class="o">=</span> <span class="n">ts_df</span>
    
    <span class="n">ts_piv_df</span> <span class="o">=</span> <span class="n">ts_df</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;drsm&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;paper_count&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;clinical characteristics or disease pathology&#39;</span><span class="p">,</span> <span class="s1">&#39;therapeutics in the clinic&#39;</span><span class="p">]:</span>
      <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ts_piv_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">ts_piv_df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>      
    <span class="n">ts_piv_df</span><span class="p">[</span><span class="s1">&#39;clinical&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ts_piv_df</span><span class="p">[</span><span class="s1">&#39;clinical characteristics or disease pathology&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">ts_piv_df</span><span class="p">[</span><span class="s1">&#39;therapeutics in the clinic&#39;</span><span class="p">]</span>
    <span class="c1">#ts_piv_df = ts_piv_df.set_index(pd.DatetimeIndex(ts_piv_df[&#39;date&#39;]))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;clinical&#39;</span><span class="p">,</span> <span class="s1">&#39;disease mechanism&#39;</span><span class="p">,</span> <span class="s1">&#39;patient-based therapeutics&#39;</span><span class="p">]</span>
    <span class="n">ts_piv_df</span> <span class="o">=</span> <span class="n">ts_piv_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">ts_piv_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">])</span>
    
    <span class="n">prophet_models</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">threshold</span> <span class="o">=</span> <span class="mf">0.01</span>
    <span class="n">trends</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">changepoints</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ts_piv_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">continue</span>
      <span class="n">df1</span> <span class="o">=</span> <span class="n">ts_piv_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;date&#39;</span><span class="p">:</span><span class="s1">&#39;ds&#39;</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span><span class="s1">&#39;y&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">cc</span> <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cols</span> <span class="k">if</span> <span class="n">cc</span><span class="o">!=</span><span class="n">c</span> <span class="ow">and</span> <span class="n">cc</span> <span class="ow">in</span> <span class="n">ts_piv_df</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span>  
      <span class="n">model</span> <span class="o">=</span> <span class="n">Prophet</span><span class="p">(</span><span class="n">seasonality_mode</span><span class="o">=</span><span class="s1">&#39;additive&#39;</span><span class="p">,</span> <span class="n">changepoint_range</span><span class="o">=</span><span class="mf">0.99</span><span class="p">)</span>
      <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df1</span><span class="p">)</span>
      <span class="n">future</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">make_future_dataframe</span><span class="p">(</span><span class="n">periods</span><span class="o">=</span><span class="mi">12</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;MS&#39;</span><span class="p">)</span>
      <span class="n">forecast</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">future</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">trends</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ds&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
        <span class="n">trends</span><span class="p">[</span><span class="s1">&#39;ds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">forecast</span><span class="p">[</span><span class="s1">&#39;ds&#39;</span><span class="p">]</span>
      <span class="n">trends</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">forecast</span><span class="p">[</span><span class="s1">&#39;trend&#39;</span><span class="p">]</span>
      <span class="n">cps</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">changepoints</span><span class="p">[</span> <span class="c1"># Note - derived from how changepoints are computed in Prophet</span>
            <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;delta&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="n">threshold</span>
        <span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">changepoints</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">[]</span> 
      <span class="n">changepoints</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cps</span><span class="p">]</span>
      <span class="n">prophet_models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">model_to_json</span><span class="p">(</span><span class="n">model</span><span class="p">)))</span>
    
    <span class="bp">self</span><span class="o">.</span><span class="n">prophet_models</span> <span class="o">=</span> <span class="n">prophet_models</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">trends_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">trends</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">changepoints</span> <span class="o">=</span> <span class="n">changepoints</span>

  <span class="k">def</span> <span class="nf">plot_raw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Plots a line graph of raw monthly publication counts within the corpus for each study category </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">ig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.autolayout&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="s2">&quot;paper_count&quot;</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_df</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;drsm&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span> <span class="p">(</span><span class="n">rotation</span> <span class="o">=</span> <span class="mi">60</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
  <span class="k">def</span> <span class="nf">plot_prophet_models</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Shows full plots of the Prophet models for each study category</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">):</span>
      <span class="n">model</span> <span class="o">=</span> <span class="n">model_from_json</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prophet_models</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
      <span class="n">future</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">make_future_dataframe</span><span class="p">(</span><span class="n">periods</span><span class="o">=</span><span class="mi">12</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;MS&#39;</span><span class="p">)</span>
      <span class="n">forecast</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">future</span><span class="p">)</span>
      <span class="n">fig</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">forecast</span><span class="p">)</span>
      <span class="n">add_changepoints_to_plot</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">gca</span><span class="p">(),</span> <span class="n">model</span><span class="p">,</span> <span class="n">forecast</span><span class="p">)</span>
      <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
      <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
      <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
      
  <span class="k">def</span> <span class="nf">plot_trends</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">long_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trends_df</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ds&#39;</span><span class="p">],</span> <span class="n">value_vars</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;drsm&#39;</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s1">&#39;monthly_publication_count&#39;</span><span class="p">)</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">set_theme</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">&quot;darkgrid&quot;</span><span class="p">)</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">long_df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;ds&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;monthly_publication_count&quot;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;drsm&quot;</span><span class="p">)</span>
    <span class="n">g</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">event_lines</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">rl</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_lines</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">rl</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">compute_history_euclidean_distance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">that</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">that</span><span class="p">,</span> <span class="n">DRSM</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Can only complare DRSM instances, not &quot;</span><span class="o">+</span><span class="nb">type</span><span class="p">(</span><span class="n">that</span><span class="p">))</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">):</span>
      <span class="n">s_y1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trends_df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
      <span class="n">cp1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_index_of_first_changepoint</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
      <span class="n">l1</span> <span class="o">=</span> <span class="n">s_y1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="n">s_y2</span> <span class="o">=</span> <span class="n">that</span><span class="o">.</span><span class="n">trends_df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
      <span class="n">cp2</span> <span class="o">=</span> <span class="n">that</span><span class="o">.</span><span class="n">get_index_of_first_changepoint</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
      <span class="n">l2</span> <span class="o">=</span> <span class="n">s_y2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="k">if</span> <span class="n">l2</span> <span class="o">&gt;</span> <span class="n">l1</span><span class="p">:</span>
        <span class="n">s_y1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">s_y1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="n">s_y1</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">*</span> <span class="p">(</span><span class="n">l2</span><span class="o">-</span><span class="n">l1</span><span class="p">))</span>
        <span class="n">cp1</span> <span class="o">+=</span> <span class="n">l2</span><span class="o">-</span><span class="n">l1</span>
      <span class="k">if</span> <span class="n">l1</span> <span class="o">&gt;</span> <span class="n">l2</span><span class="p">:</span>
        <span class="n">s_y2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">s_y2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="n">s_y2</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">*</span> <span class="p">(</span><span class="n">l1</span><span class="o">-</span><span class="n">l2</span><span class="p">))</span>  
        <span class="n">cp2</span> <span class="o">+=</span> <span class="n">l1</span><span class="o">-</span><span class="n">l2</span>
      <span class="n">denominator</span> <span class="o">=</span> <span class="n">s_y1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">cp1</span><span class="p">,</span> <span class="n">cp2</span><span class="p">)</span>
      <span class="n">d</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">s_y1</span><span class="o">*</span><span class="n">s_y1</span> <span class="o">+</span> <span class="n">s_y2</span><span class="o">*</span><span class="n">s_y2</span><span class="p">))</span> <span class="o">/</span> <span class="n">denominator</span><span class="p">)</span>  
    <span class="k">return</span> <span class="n">d</span>
  
  <span class="k">def</span> <span class="nf">get_index_of_first_changepoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="n">date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">changepoints</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trends_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">trends_df</span><span class="o">.</span><span class="n">ds</span> <span class="o">==</span> <span class="n">date</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">index</span>
  
  <span class="k">def</span> <span class="nf">scrape_fda_website_for_drug_approvals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">activesoup</span><span class="o">.</span><span class="n">Driver</span><span class="p">()</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;https://www.accessdata.fda.gov/scripts/opdlisting/oopd/&quot;</span><span class="p">)</span>
    <span class="n">form1</span><span class="p">,</span> <span class="n">form2</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;form&#39;</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">form2</span><span class="o">.</span><span class="n">submit</span><span class="p">({</span><span class="s2">&quot;Designation&quot;</span><span class="p">:</span> <span class="s1">&#39;%&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;%&#39;</span><span class="p">,</span>
                    <span class="s2">&quot;Designation_Start_Date&quot;</span><span class="p">:</span> <span class="s2">&quot;01/01/1983&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Designation_End_Date&quot;</span><span class="p">:</span> <span class="s2">&quot;07/25/2022&quot;</span><span class="p">,</span> 
                    <span class="s2">&quot;Search_param&quot;</span><span class="p">:</span> <span class="s2">&quot;DESDATE&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Output_Format&quot;</span><span class="p">:</span> <span class="s2">&quot;Short&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Sort_order&quot;</span><span class="p">:</span> <span class="s2">&quot;GENERIC_NAME&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;RecordsPerPage&quot;</span><span class="p">:</span> <span class="mi">25</span><span class="p">})</span>
    <span class="n">bsoup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">_raw_response</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s2">&quot;html.parser&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bsoup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;th&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_html</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">bsoup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;th&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="p">),</span> <span class="n">extract_links</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">designations_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_html</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">bsoup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;th&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">approvals_dflist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
      <span class="n">name</span><span class="p">,</span> <span class="n">url</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
      <span class="n">designation</span><span class="p">,</span> <span class="n">nuttin</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
      <span class="k">if</span> <span class="s1">&#39;Approved&#39;</span> <span class="ow">in</span> <span class="n">designation</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;.*\((\d+)\).*&#39;</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
          <span class="nb">id</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
          <span class="nb">print</span><span class="p">()</span>
          <span class="n">d</span> <span class="o">=</span> <span class="n">activesoup</span><span class="o">.</span><span class="n">Driver</span><span class="p">()</span>
          <span class="n">r2</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;https://www.accessdata.fda.gov/scripts/opdlisting/oopd/detailedIndex.cfm?cfgridkey=&#39;</span><span class="o">+</span><span class="nb">id</span><span class="p">)</span>
          <span class="n">bsoup2</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">r2</span><span class="o">.</span><span class="n">_raw_response</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s2">&quot;html.parser&quot;</span><span class="p">)</span>
          <span class="n">table_list</span> <span class="o">=</span> <span class="n">bsoup2</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s2">&quot;table&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="s2">&quot;resultstable&quot;</span><span class="p">})</span>
          <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">table_list</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">j</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
              <span class="k">continue</span>
            <span class="n">df2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_html</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># important data is generic name (r0c2) / trade name (r1c2) / approval date (r2c2) / Approved Labeled Indication (r3c2)</span>
            <span class="n">generic_name</span> <span class="o">=</span> <span class="n">df2</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">trade_name</span> <span class="o">=</span> <span class="n">df2</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">approval_date</span> <span class="o">=</span> <span class="n">df2</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">approved_labeled_indication</span> <span class="o">=</span> <span class="n">df2</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">approvals_dflist</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">generic_name</span><span class="p">,</span> <span class="n">trade_name</span><span class="p">,</span> <span class="n">approval_date</span><span class="p">,</span> <span class="n">approved_labeled_indication</span><span class="p">))</span>
    <span class="n">approvals_df</span> <span class="o">=</span>  <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">approvals_dflist</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;generic_name&#39;</span><span class="p">,</span> <span class="s1">&#39;trade_name&#39;</span><span class="p">,</span> <span class="s1">&#39;approval_date&#39;</span><span class="p">,</span> <span class="s1">&#39;approved_labeled_indication&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">designations_df</span><span class="p">,</span> <span class="n">approvals_df</span>
  
  
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>* Owlready2 * Warning: optimized Cython parser module &#39;owlready2_optimized&#39; is not available, defaulting to slower Python implementation
Importing plotly failed. Interactive plots will not work.
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

</div>


