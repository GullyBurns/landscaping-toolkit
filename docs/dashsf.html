---

title: Dashboard Database Utilities


keywords: fastai
sidebar: home_sidebar

summary: "Simple query classes that allows contruction of a SQL database in Snowflake for science literature dashboard applications. Note that this implementation is intended primarily for internal CZI use."
description: "Simple query classes that allows contruction of a SQL database in Snowflake for science literature dashboard applications. Note that this implementation is intended primarily for internal CZI use."
nb_path: "nbdev/utils/06_dashsf.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbdev/utils/06_dashsf.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div  class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/snowflake/connector/options.py:96: UserWarning: You have an incompatible version of &#39;pyarrow&#39; installed (11.0.0), please install a version that adheres to: &#39;pyarrow&lt;6.1.0,&gt;=6.0.0; extra == &#34;pandas&#34;&#39;
  warn_incompatible_dep(
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div  class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><img src="https://lucid.app/publicSegments/view/0388e058-e5f8-4914-9536-f718edf21d47/image.jpeg" alt="Schema for Dashboard Database" /></p>
<p>Image source on LucidDraw: <a href="https://lucid.app/lucidchart/29f3e2c7-cd56-46fa-a6ce-0dda18d819e1/edit?viewport_loc=-2670%2C-1547%2C3099%2C1648%2CoxaLRZ4JBiatT&amp;invitationId=inv_64fde248-ce31-40b5-85d5-2f3317b5f876#">Link</a></p>

</div>
</div>
</div>
<div  class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Use this class to run queries from a spreadsheet across various online academic graph systems and generate a database based on the data from those queries.</p>
<p>If we had a dataframe <code>query_df</code> where one of the columns described a literature query expressed in Boolean Logic:</p>
<table>
<thead>
<tr>
  <th>ID</th>
  <th>DISEASE NAME</th>
  <th>MONDO_ID</th>
  <th>QUERY</th>
</tr>
</thead>
<tbody>
<tr>
  <td>1</td>
  <td>Adult Polyglucosan Body Disease</td>
  <td>MONDO:0009897</td>
  <td>adult polyglucosan body disease | adult polyglucosan body neuropathy</td>
</tr>
<tr>
  <td>2</td>
  <td>Creatine transporter deficiency</td>
  <td>MONDO:0010305</td>
  <td>creatine transporter deficiency | guanidinoacetate methyltransferase deficiency | AGAT deficiency | cerebral creatine deficiency syndrome 1 | X-linked creatine deficiency syndrome | Cerebral Creatine Deficiency Syndromes | creatine transporter defect | SLC6A8 deficiency | X-linked creatine transporter deficiency | X-linked creatine deficiency | X-linked creatine deficiency syndrome | guanidinoacetate methyltransferase deficiency | guanidinoacetate N-methyltransferase activity disease | GAMT deficiency | glycine amidinotransferase activity disease | arginine:glycine amidinotransferase deficiency | AGAT deficiency | GATM deficiency</td>
</tr>
<tr>
  <td>3</td>
  <td>AGAT deficiency</td>
  <td>MONDO:0012996</td>
  <td>&quot;GATM deficiency&quot; | &quot;AGAT deficiency&quot; | &quot;arginine:glycine amidinotransferase deficiency&quot; | &quot;L-arginine:glycine amidinotransferase deficiency&quot;</td>
</tr>
<tr>
  <td>4</td>
  <td>Guanidinoacetate methyltransferase deficiency</td>
  <td>MONDO:0012999</td>
  <td>&quot;guanidinoacetate methyltransferase deficiency&quot; | &quot;GAMT deficiency&quot;</td>
</tr>
<tr>
  <td>5</td>
  <td>CLOVES Syndrome</td>
  <td>MONDO:0013038</td>
  <td>&quot;CLOVES syndrome | (congenital lipomatous overgrowth) &amp; (vascular malformation epidermal) &amp; (nevi-spinal) &amp; syndrome | (congenital lipomatous overgrowth) &amp; (vascular malformations) &amp; (Epidermal nevi) &amp; ((skeletal|spinal) &amp; abnormalities) | CLOVE syndrome | (congenital lipomatous overgrowth) &amp; (vascular malformation) &amp; (epidermal nevi)</td>
</tr>
</tbody>
</table>
<p>It is straightforward to build a database of all corpora listed in the spreadsheet from the search queries expressed in the <code>QUERY</code> column:</p>
<pre><code>from czLandscapingTk.airtableUtils import AirtableUtils
from czLandscapingTk.dashdbUtils import DashboardDb
from czLandscapingTk.generalUtils import dump_data_to_disk
import re

at_ID_column = 'ID'
at_query_column = 'QUERY'

# this will be substituted into the tables above instead of 'PREFIX_'
prefix = 'MY_AMAZING_DATABASE_' 

# Databricks secret management
secret_scope = 'secret-scope' 

# Location of data in SNOWFLAKE
warehouse = 'DEV_WAREHOUSE'
database = 'DEV_DB' 
schema = 'SKE'

# SNOWFLAKE role for permissions
role = 'ARST_TEAM'

# Location of temp files in Databricks file storage
loc = '/dbfs/FileStore/user/gully/'

# See https://ncbiinsights.ncbi.nlm.nih.gov/2017/11/02/new-api-keys-for-the-e-utilities/
pubmed_api_key = 'blahblahblahblah' 

# SNOWFLAKE Login credentials to be stored in secrets
user = dbutils.secrets.get(scope=secret_scope, key=&quot;SNOWFLAKE_SERVICE_USERNAME&quot;)
pem = dbutils.secrets.get(scope=secret_scope, key=&quot;SNOWFLAKE_SERVICE_PRIVATE_KEY&quot;)
pwd = dbutils.secrets.get(scope=secret_scope, key=&quot;SNOWFLAKE_SERVICE_PASSPHRASE&quot;)

# Execution of the query and generation of the dashboard database
dashdb = DashboardDb(prefix, user, pem, pwd, warehouse, database, schema, role, loc)
corpus_paper_df = dashdb.run_remote_paper_queries(pubmed_api_key, queries_df, at_ID_column, at_query_column, 
    sf_include=False, pm_include=True, epmc_include=False)
</code></pre>
<p>The parameters <code>sf_include</code>, <code>pm_include</code>, and <code>empc_include</code> denote whether the Boolean queries listed will be run on (A) our own internal SNOWFLAKE database; (B) Pubmed; and (C) European PMC. Records for each of these databases are differentiated based on the <code>CORPUS</code></p>

</div>
</div>
</div>
    {% raw %}
    
<div  class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_markdown rendered_html output_subarea ">
<h2 id="Snowflake" class="doc_header"><code>class</code> <code>Snowflake</code><a href="https://github.com/GullyBurns/czLandscapingTk/tree/master/czLandscapingTk/dashdbUtils.py#L18" class="source_link" style="float:right">[source]</a></h2>
<blockquote>
<p><code>Snowflake</code>(<strong><code>user</code></strong>, <strong><code>pem</code></strong>, <strong><code>pwd</code></strong>, <strong><code>warehouse</code></strong>, <strong><code>database</code></strong>, <strong><code>schema</code></strong>, <strong><code>role</code></strong>)</p>
</blockquote>
<p>Class to provide simple access to Snowflake from within CZI</p>
<p>Attributes (note - store <code>user</code>, <code>pem</code>, and <code>pwd</code> as <code>dbutils.secret</code> data ):</p>
<ul>
<li>user: Snowflake username</li>
<li>pem: SSH key</li>
<li>pwd: Password for SSH key</li>
<li>warehouse: name of the SNOWFLAKE warehouse</li>
<li>database: name of the SNOWFLAKE database</li>
<li>schema: name of the SNOWFLAKE schema</li>
<li>role: name of the SNOWFLAKE role with correct permissions to execute database editing</li>
</ul>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div  class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div  class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_markdown rendered_html output_subarea ">
<h4 id="Snowflake.get_cursor" class="doc_header"><code>Snowflake.get_cursor</code><a href="__main__.py#L63" class="source_link" style="float:right">[source]</a></h4>
<blockquote>
<p><code>Snowflake.get_cursor</code>()</p>
</blockquote>
<p>Gets an active cursor for use within the database</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div  class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_markdown rendered_html output_subarea ">
<h4 id="Snowflake.execute_query" class="doc_header"><code>Snowflake.execute_query</code><a href="__main__.py#L75" class="source_link" style="float:right">[source]</a></h4>
<blockquote>
<p><code>Snowflake.execute_query</code>(<strong><code>cs</code></strong>, <strong><code>sql</code></strong>, <strong><code>columns</code></strong>)</p>
</blockquote>
<p>Executes an SQL query with a list of column names and returns a Pandas DataFrame</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div  class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_markdown rendered_html output_subarea ">
<h2 id="DashboardDb" class="doc_header"><code>class</code> <code>DashboardDb</code><a href="https://github.com/GullyBurns/czLandscapingTk/tree/master/czLandscapingTk/dashdbUtils.py#L139" class="source_link" style="float:right">[source]</a></h2>
<blockquote>
<p><code>DashboardDb</code>(<strong><code>prefix</code></strong>, <strong><code>user</code></strong>, <strong><code>pem</code></strong>, <strong><code>pwd</code></strong>, <strong><code>warehouse</code></strong>, <strong><code>database</code></strong>, <strong><code>schema</code></strong>, <strong><code>role</code></strong>, <strong><code>loc</code></strong>)</p>
</blockquote>
<p>This class permits the construction of a database of resources generated from combining a list of queries with a list of subqueries on multiple online repositories.<BR>
Functionality includes:</p>
<ul>
<li>Define a spreadsheet with a column of queries expressed in boolean logic</li>
<li>Optional: Define a secondary spreadsheet with a column of subqueries expressed in boolean logic</li>
<li>Iterate over different sources (Pubmed + European Pubmed) to execute all combinations of queries and subqueries</li>
<li>Store extended records for all papers - including full text where available from CZI's internal data repo.</li>
</ul>
<p>Attributes (note - store <code>user</code>, <code>pem</code>, and <code>pwd</code> as <code>dbutils.secret</code> data ):</p>
<ul>
<li>prefix: a string that will be used as the prefix for each table in the database</li>
<li>user: Snowflake username</li>
<li>pem: SSH key</li>
<li>pwd: Password for SSH key</li>
<li>warehouse: name of the SNOWFLAKE warehouse</li>
<li>database: name of the SNOWFLAKE database</li>
<li>schema: name of the SNOWFLAKE schema</li>
<li>role: name of the SNOWFLAKE role with correct permissions to execute database editing</li>
<li>loc: local disk location for files</li>
</ul>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div  class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div  class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_markdown rendered_html output_subarea ">
<h4 id="DashboardDb.run_remote_paper_queries" class="doc_header"><code>DashboardDb.run_remote_paper_queries</code><a href="__main__.py#L143" class="source_link" style="float:right">[source]</a></h4>
<blockquote>
<p><code>DashboardDb.run_remote_paper_queries</code>(<strong><code>pubmed_api_key</code></strong>, <strong><code>query_df</code></strong>, <strong><code>id_col</code></strong>, <strong><code>q_col</code></strong>, <strong><code>subquery_df</code></strong>=<em><code>None</code></em>, <strong><code>subq_col</code></strong>=<em><code>None</code></em>, <strong><code>delete_db</code></strong>=<em><code>True</code></em>, <strong><code>pm_include</code></strong>=<em><code>True</code></em>, <strong><code>epmc_include</code></strong>=<em><code>True</code></em>, <strong><code>sf_include</code></strong>=<em><code>True</code></em>)</p>
</blockquote>
<p>Function to generate a snowflake database of scientific papers based on a list of queries listed in a dataframe 
(and possibly faceted by a second set of queries in a second dataframe). This system will (optionally) 
execute queries on the REST services of Pubmed and European PMC to build the database.</p>
<p>Attributes:</p>
<ul>
<li>pubmed_api_key: see <a href="https://ncbiinsights.ncbi.nlm.nih.gov/2017/11/02/new-api-keys-for-the-e-utilities/">https://ncbiinsights.ncbi.nlm.nih.gov/2017/11/02/new-api-keys-for-the-e-utilities/</a></li>
<li>query_df: a Pandas Dataframe of corpora where one column specifies the query</li>
<li>id_col: ID column used to identify the corpus</li>
<li>q_col: column for the query (expressed using '&amp;' for AND and '|' for OR)</li>
<li>subquery_df: an optional Pandas Dataframe of subqueries</li>
<li>subq_col: an optional column for the subquery (expressed using '&amp;' for AND and '|' for OR)</li>
<li>delete_db (default=True): delete the existing database?</li>
<li>pm_include (default=True): Run corpus construction queries on Pubmed</li>
<li>epmc_include (default=True): Run corpus construction queries on European PMC</li>
</ul>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

</div>


